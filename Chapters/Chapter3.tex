% Chapter 1

\chapter{The ionic problem} % Main chapter title

\label{Chapter3} % For referencing the chapter elsewhere, use \ref{Chapter1} 

%----------------------------------------------------------------------------------------

The adiabatic BOA allowed us to separate the electronic and ionic problems. So far, we have shown how to solve the electronic part. Electronic degrees of freedom are responsible for many properties 
of solids, nevertheless, many other, such us, thermal and electrical resistivity arise due to ionic degrees of freedom. \\

In order to study the dynamics of ions we have to solve the nuclear Schr\"odinger equation in Eq. 
\ref{schrodinger-nuclei}. As we saw in Eq. \ref{nuclei}, the ions move in a potential given by the previously 
calculated electronic total ground state energy which is usually named Born-Oppenheimer Energy Surface (BOES). \\

The BOES has around $10^{23}$ degrees of freedom and it is an extremely complex energy landscape. The nuclear Hamiltonian is unsolvable unless the problem is simplified by applying approximations. The first non-trivial 
approximation we can adopt to solve this problem is the harmonic approximation, which is a low-order expansion of the BOES in the atomic displacements and is justified by the fact that in many solids the atomic displacements are 
much smaller than the interatomic distances\cite{ashcroft1976solid}.

\section{The harmonic approximation}
\label{harmonic-approximation}

From now on the ions are not frozen and are allowed to move. The harmonic approximation departs from the classical picture where the atoms oscillate around their equilibrium positions. These equilibrium positions are defined as 
the minimum of the BOES. In this framework the position of the $s^{th}$ atom in the $m^{th}$ unit cell can be described as
\begin{equation}
 \mathbf{R}_{s}(\mathbf{T}_{m})=\mathbf{T}_{m}+\boldsymbol{\tau}_{s}+\mathbf{u}_{s}(\mathbf{T}_{m})=\mathbf{R}_{s}^{0}(\mathbf{T}_{m})+\mathbf{u}_{s}(\mathbf{T}_{m}),
\end{equation}  
where $\mathbf{u}_{s}(\mathbf{T}_{m})$ is the displacement of the atom from its equilibrium position $\mathbf{R}_{s}^{0}(\mathbf{T}_{m})$, $\mathbf{T}_{m}$ is the lattice vector from the origin to the origin of the $m^{th}$ 
cell, and $\boldsymbol{\tau}_{s}$ is the basis vector that denotes the equilibrium position of the atom inside the unit cell. Once we have set the equilibrium atomic positions we can Taylor expand the BOES in the atomic displacements
\begin{multline}
 \label{taylor-expansion}
 U(\mathbf{R})=U(\mathbf{R}^{0})+\sum_{n=2}^{\infty}U_{n}, \\ U_{n}=\frac{1}{n!}\sum\limits_{\substack{s_{1}\dots s_{n} \\ \alpha_{1}\dots\alpha_{n} \\ \mathbf{T}_{1},\dots,\mathbf{T}_{n}}} 
 \overset{(n)}{\phi}{}_{s_{1}\dots s_{n}}^{\alpha_{1}\dots\alpha_{n}}(\mathbf{T}_{1},\dots,\mathbf{T}_{n})u_{s_{1}}^{\alpha_{1}}(\mathbf{T}_{1})\dots u_{s_{n}}^{\alpha_{n}}(\mathbf{T}_{n}),
\end{multline}
with
\begin{equation}
 \label{perturbative-nbfc}
 \overset{(n)}{\phi}{}_{s_{1}\dots s_{n}}^{\alpha_{1}\dots\alpha_{n}}(\mathbf{T}_{1},\dots,\mathbf{T}_{n})=\frac{\partial^{n}U}{\partial u_{s_{1}}^{\alpha_{1}}(\mathbf{T}_{1})\dots\partial u_{s_{n}}^{
 \alpha_{n}}(\mathbf{T}_{n})}\vline_{_{_{_{_{_{_{_{_{\mathbf{R}^{0}}}}}}}}}}.
\end{equation}
The number of possible $\mathbf{T}$ lattice vectors is equal to the number of unit cells. The atom index $s$ goes from $1$ to $N_{s}$, the number of atoms per unit cell, and $\alpha$ runs on the Cartesian coordinates $x$, $y$, and 
$z$. $\overset{(n)}{\phi}{}_{s_{1},\dots,s_{n}}^{\alpha_{1},\dots,\alpha_{n}}(\mathbf{T}_{1},\dots,\mathbf{T}_{n})$ 
are the $n$ body force-constants ($n$BFC). For the 2BFC we omit the index $(2)$. As a rigid shift of the crystal 
cannot change the energy of the system, 2BFC fulfill the following equality
\begin{equation}
\label{acoustic-sum-rule}
\sum_{\mathbf{T}_{1},\alpha_{1},s_{1}}\phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})=0,
\end{equation}
which is named acoustic sum rule (ASR). The ASR can be generalized to any nBFC. \\

In principle, the ionic configuration $\mathbf{R}$ depends on the three lattice vectors of the system $\mathbf{R}\equiv\mathbf{R}(\{\mathbf{a}_{i}\})$ $i=1,2,3$ and, therefore, the BOES also depends on them. The Born-Oppenheimer stress 
tensor can be defined as
\begin{equation}
\label{bo-stress}
 P_{\alpha\beta}^{BO}(\mathbf{R})=-\frac{1}{\Omega}\frac{\partial U(\mathbf{R})}{\partial\epsilon_{\alpha\beta}}\vline_{_{_{_{_{_{_{_{\boldsymbol{\epsilon}=0}}}}}}}},
\end{equation} 
where $\epsilon_{\alpha\beta}$ is the strain tensor. From now on we will suppose that the BOES is defined for any stress tensor and $\mathbf{R}^{0}$ is the atomic configuration that minimizes that BOES. It is important to note 
that the stress tensor in Eq. \ref{bo-stress} does not include any effect from the thermal or quantum fluctuations of the ions, it is just the derivative of the total electronic energy with respect to the strain tensor. \\
 
Since we are at a local minimum of the BOES, the first-order term $U_{1}$ is zero by definition, thus, the lowest-order approximation we can do for the nuclear motion is to keep the terms up to second-order in the atomic 
displacements. The lowest-order approximation is named harmonic approximation. The harmonic Hamiltonian reads
\begin{equation}
\label{harmonic_hamiltonian}
 H^{I}(\mathbf{R})\simeq\sum_{\mathbf{T}s\alpha}\frac{(P_{s}^{\alpha}(\mathbf{T}))^{2}}{2m_{s}}+U(\mathbf{R}^{0})+U_{2}(\mathbf{R}).
\end{equation}
We will name higher-order terms ($n>2$) anharmonic terms. It is convenient to Fourier transform the 2BFC  with the following general Fourier transform for any $n$BFC
\begin{equation}
 \label{2bfc-fourier}
 \overset{(n)}{\phi}{}_{s_{1}\dots s_{n}}^{\alpha_{1}\dots\alpha_{n}}(\mathbf{T}_{1},\dots,\mathbf{T}_{n})=\frac{1}{N_{\mathbf{q}}^{n-1}}\sum_{\mathbf{q}_{1}\dots\mathbf{q}_{n}}e^{i(\mathbf{q}_{1}\cdot\mathbf{T}_{1}+\dots+\mathbf{q}_{
 n}\cdot\mathbf{T}_{n})}\overset{(n)}{\phi}{}_{s_{1}\dots s_{n}}^{\alpha_{1}\dots\alpha_{n}}(\mathbf{q}_{1},\dots,\mathbf{q}_{n}),
\end{equation}
where $N_{\mathbf{q}}$ is the number of $\mathbf{q}$ points in the 1BZ, or equivalently, the number of allowed $\mathbf{T}$ lattice vectors. Due to the translational symmetry of the crystal, 2BFC have translational invariance and only 
depend on $\mathbf{T}=\mathbf{T}_{1}-\mathbf{T}_{2}$. Therefore, only the terms with $\mathbf{q}_{1}=-\mathbf{q}_{2}$ are non-zero in 
Eq. \ref{2bfc-fourier} and the equation can be rewritten
\begin{equation}
 \label{2bfc-fourier-simple}
 \phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{q})=\phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{q},-\mathbf{q})=\sum_{\mathbf{T}}\phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T},0)e^{-i\mathbf{
 q}\cdot\mathbf{T}},
\end{equation} 
where $\mathbf{q}=\mathbf{q}_{1}=-\mathbf{q}_{2}$. In the same way we can define the Fourier transforms of the displacement and momentum operators
\begin{equation}
 \label{displacement-fourier}
 u_{s}^{\alpha}(\mathbf{q})=\frac{1}{\sqrt{N_{\mathbf{q}}}}\sum_{\mathbf{T}}e^{i\mathbf{q}\cdot\mathbf{T}}u_{s}^{\alpha}(\mathbf{T}),
\end{equation}
\begin{equation}
 \label{momentum-fourier}
 P_{s}^{\alpha}(\mathbf{q})=\frac{1}{\sqrt{N_{\mathbf{q}}}}\sum_{\mathbf{T}}e^{-i\mathbf{q}\cdot\mathbf{T}}P_{s}^{\alpha}(\mathbf{T}).
\end{equation}
\\

We will see that these definitions will allow us to diagonalize the ionic Hamiltonian. First of all we assume the following transformations with the bosonic ladder operators
\begin{equation}
 \label{displacement-quantization}
 u_{s}^{\alpha}(\mathbf{q})=\sum_{\mu}\frac{1}{\sqrt{2m_{s}\omega_{\mu}(\mathbf{q})}}\epsilon_{s\mu}^{\alpha}(\mathbf{q})(b_{\mu\mathbf{q}}+b_{\mu-\mathbf{q}}^{\dagger}),
\end{equation}
\begin{equation}
 \label{momentum-quantization}
 P_{s}^{\alpha}(\mathbf{q})=-i\sum_{\mu}\sqrt{\frac{m_{s}\omega_{\mu}(\mathbf{q})}{2}}\epsilon_{s\mu}^{\alpha}(\mathbf{q})(b_{\mu\mathbf{q}}-b_{\mu-\mathbf{q}}^{\dagger}),
\end{equation}
that satisfy the following commutation algebra
\begin{equation}
 [b_{\mu\mathbf{q}},b^{\dagger}_{\mu'\mathbf{q}'}]=\delta_{\mu\mu'}\delta_{\mathbf{q}\mathbf{q}'}, \hspace{0.2cm} [b_{\mu\mathbf{q}},b_{\mu'\mathbf{q}'}]=0, \hspace{0.2cm} 
 [b^{\dagger}_{\mu\mathbf{q}},b^{\dagger}_{\mu'\mathbf{q}'}]=0.
\end{equation}
The polarization vectors and phonon frequencies are calculated solving the eigenvalue problem of the dynamical matrix $D_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{q})=\phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{
2}}(\mathbf{q})/\sqrt{m_{s_{1}}m_{s_{2}}}$
\begin{equation}
 \omega_{\mu}^{2}(\mathbf{q})\epsilon_{s_{1}\mu}^{\alpha_{1}}(\mathbf{q})=\sum_{s_{2}}\sum_{\alpha_{2}}D_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{q})\epsilon_{s_{2}\mu}^{\alpha_{2}}(\mathbf{q}).
\end{equation}
By using these definitions, the ionic Hamiltonian in the harmonic approximation can be written as a sum of independent harmonic oscillators\cite{ashcroft1976solid,mahan2013many,born1954dynamical}
\begin{equation}
 \label{diagonal-ionic-hamiltonian}
 H^{I}=U(\mathbf{R}^{0})+\sum_{\mu}\sum_{\mathbf{q}}^{1BZ}\omega_{\mu}(\mathbf{q})\left(b_{\mu\mathbf{q}}^{\dagger}b_{\mu\mathbf{q}}+\frac{1}{2}\right),
\end{equation}
with the following eigenenergies
\begin{equation}
 \label{ionic-eigenvalues}
 E^{mode}_{\mu}(\mathbf{q})=U(\mathbf{R}^{0})+\omega_{\mu}(\mathbf{q})\left(n_{\mu\mathbf{q}}+\frac{1}{2}\right).
\end{equation}
$\boldsymbol{\epsilon}_{s\mu}(\mathbf{q})$ and $\omega_{\mu}(\mathbf{q})$ are the polarization vector (of atom $s$ in the unit cell) and the frequency of mode $\mu$ with 
momentum $\mathbf{q}$, respectively. $n_{\mu\mathbf{q}}$ denotes the occupation level of a mode, when a given mode is excited to the $n^{th}_{\mu\mathbf{q}}$ level, we would say that we have $n_{\mu\mathbf{q}}$ 
phonons of that mode. We will name $\omega_{\mu}(\mathbf{q})$ $phonon$ $frequencies$ and their dispersion with respect to momentum $phonon$ $spectrum$. The ASR makes $D_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{q}=0)$ to have three null eigenvalues, which correspond to the three acoustic branches at the $\Gamma$ point. \\

Finally, the energy of a total ionic state $|\beta\rangle=|n_{1\mathbf{q}_{1}}\dots n_{3N_{s}\mathbf{q}_{1}}\dots n_{3N_{s}\mathbf{q}_{N_{\mathbf{q}}}}\rangle$, is given by
\begin{equation}
 E_{\beta}=U(\mathbf{R}^{0})+\sum_{\mu}\sum_{\mathbf{q}}^{1BZ}\omega_{\mu}(\mathbf{q})\left(n_{\mu\mathbf{q}}+\frac{1}{2}\right).
\end{equation}
As phonons are bosons, they follow Bose-Einstein statistics and the total energy at a given temperature can be calculated as
\begin{equation}
 E(T)=U(\mathbf{R}^{0})+\sum_{\mu}\sum_{\mathbf{q}}^{1BZ}\omega_{\mu}(\mathbf{q})\left(n_{B}(\omega_{\mu}(\mathbf{q}))+\frac{1}{2}\right),
\end{equation}
where 
\begin{equation}
 n_{B}(\omega_{\mu}(\mathbf{q}))=(e^{\beta\omega_{\mu}(\mathbf{q})}-1)^{-1}
\end{equation}
is the Bose-Einstein distribution function. The zero point energy (ZPE) is defined as
\begin{equation}
 E_{ZPE}=E(T=0)=U(\mathbf{R}^{0})+\frac{1}{2}\sum_{\mu}\sum_{\mathbf{q}}^{1BZ}\omega_{\mu}(\mathbf{q})
\end{equation}
and arises from the quantum fluctuations of the atoms at $T=0$ K.

\section{Phonons from density functional perturbation theory}
\label{dfpt-2bfc}

We have seen that within the simplest approximation to study the motion of nuclei we need to calculate second derivatives of $U(\mathbf{R})$ at the minimum of the BOES or the 2BFC. We can start by calculating the 
first-order derivatives of $U(\mathbf{R})$. By using the Hellmann-Feynman theorem \cite{hellmann1937forces,feynman1939forces} we get
\begin{equation}
 \frac{\partial U}{\partial u_{s_{1}}^{\alpha_{1}}(\mathbf{T}_{1})}=\langle\psi_{0}^{e}|\frac{\partial H^{e}}{\partial u_{s_{1}}^{\alpha_{1}}(\mathbf{T}_{1})}|\psi_{0}^{e}\rangle=\frac{\partial V_{I,I}}{\partial u_{s_{1}}^{
 \alpha_{1}}(\mathbf{T}_{1})}+\int{d\mathbf{x}n(\mathbf{x})\frac{\partial V_{ext}(\mathbf{x})}{\partial u_{s_{1}}^{\alpha_{1}}(\mathbf{T}_{1})}},
\end{equation} 
since the only explicit dependence on the nuclear coordinates of $H^{e}$ comes from the external potential $V_{ext}$ and the nuclei-nuclei Coulomb interaction $V_{I,I}$. Now if we compute the 
second derivative with respect to the atomic displacements we get
\begin{multline}
 \phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})=\frac{\partial^{2}U}{\partial u_{s_{1}}^{\alpha_{1}}(\mathbf{T}_{1})\partial u_{s_{2}}^{\alpha_{2}}(\mathbf{T}_{2})}\vline_{_{_{_{_{_{_{_{_{\mathbf{R}^{
 0}}}}}}}}}} = \int{d\mathbf{x}\frac{\partial n(\mathbf{x})}{\partial u_{s_{1}}^{\alpha_{1}}(\mathbf{T}_{1})}\vline_{_{_{_{_{_{_{_{_{\mathbf{R}^{0}}}}}}}}}}}\frac{\partial V_{ext}(\mathbf{x})}{\partial u_{s_{2}}^{\alpha_{2}}(\mathbf{
 T}_{2})}\vline_{_{_{_{_{_{_{_{_{\mathbf{R}^{0}}}}}}}}}} + \\ + \int{d\mathbf{x}n(\mathbf{x})}\frac{\partial^{2}V_{ext}(\mathbf{x})}{\partial u_{s_{1}}^{\alpha_{1}}(\mathbf{T}_{1})\partial u_{s_{2}}^{\alpha_{2}}(\mathbf{T}_{
 2})}\vline_{_{_{_{_{_{_{_{_{\mathbf{R}^{0}}}}}}}}}} +  \frac{\partial^{2}V_{I,I}}{\partial u_{s_{1}}^{\alpha_{1}}(\mathbf{T}_{1})\partial u_{s_{2}}^{\alpha_{2}}(\mathbf{T}_{2})}\vline_{_{_{_{_{_{_{_{_{\mathbf{R}^{0}}}}}}}}}}. 
\end{multline}
The last equation shows that the second derivatives of the BOES not only require the knowledge of the density $n(\mathbf{x})$ but also of its derivatives with respect to nuclear 
displacements $\frac{\partial n(\mathbf{x})}{\partial u_{s}^{\alpha}(\mathbf{T})}$. We already know how to calculate the electronic density by solving the electronic problem using DFT, now we will see how to 
calculate $\frac{\partial n(\mathbf{x})}{\partial u_{s}^{\alpha}(\mathbf{T})}$ using Density Functional Perturbation Theory (DFPT)\cite{baroni1987green,gonze1995adiabatic,baroni2001phonons}. \\

The main idea behind DFPT is to apply first-order perturbation theory to calculate the change on the Kohn-Sham orbitals when the ions displace from their equilibrium positions. With the change on these 
orbitals one is able to calculate the variation of the electronic density and, consequently, the 2BFC. The first step is to make a first-order expansion of the electronic Hamiltonian, the eigenvalues, 
the eigenfunctions and, the density (see Eqs. \ref{kohn-sham} and \ref{electronic-density} for the Kohn-Sham problem and the density)
\begin{itemize}
 \item $H^{KS} \rightarrow H^{KS}+\Delta H^{KS}$
 \item $\epsilon_{n\mathbf{k}} \rightarrow \epsilon_{n\mathbf{k}} + \Delta\epsilon_{n\mathbf{k}}$
 \item $|\phi_{n\mathbf{k}}\rangle \rightarrow |\phi_{n\mathbf{k}}\rangle + |\Delta\phi_{n\mathbf{k}}\rangle$ 
 \item $n(\mathbf{x}) \rightarrow n(\mathbf{x}) + \Delta n(\mathbf{X})$,
\end{itemize}
where $\langle\mathbf{x}|\Delta\phi_{n\mathbf{k}}\rangle=\Delta\phi_{n\mathbf{k}}(\mathbf{x})$. With these ingredients we obtain another eigenvalue problem at linear order 
\begin{equation}
 \label{sternheimer1}
 (H^{KS}-\epsilon_{n\mathbf{k}})|\Delta\phi_{n\mathbf{k}}\rangle=-(\Delta H^{KS}-\Delta\epsilon_{n\mathbf{k}})|\phi_{n\mathbf{k}}\rangle,
\end{equation} 
and by deriving Eq. \ref{ground-state-density} we get
\begin{equation}
 \label{sternheimer2}
 \Delta n(\mathbf{x})=2Re\sum_{n}\sum_{\mathbf{k}}^{1BZ}2[\theta(\epsilon_{F}-\epsilon_{n\mathbf{k}})]\phi_{n\mathbf{k}}^{*}(\mathbf{x})\Delta\phi_{n\mathbf{k}}(\mathbf{x}),
\end{equation}
where $\theta(\epsilon)$ is the zero temperature Fermi-Dirac distribution function. Eq. \ref{sternheimer1} is known as the Sternheimer equation\cite{sternheimer1954electronic}. Finally, the linear change of 
the Hamiltonian can be derived using functional derivatives
\begin{equation}
 \label{sternheimer3}
 \Delta H^{KS}(\mathbf{x})=\Delta V_{ext}(\mathbf{x})+\int{d\mathbf{x}'K(\mathbf{x},\mathbf{x}')\Delta n(\mathbf{x}')},
\end{equation} 
where $K(\mathbf{x},\mathbf{x}')$ is the functional derivative of the electron-electron interaction potential with respect to the density
\begin{equation}
 K(\mathbf{x},\mathbf{x}')=\frac{\delta V_{H}(\mathbf{x})}{\delta n(\mathbf{x}')}+\frac{\delta V_{xc}(\mathbf{x})}{\delta n(\mathbf{x}')}.
\end{equation}
Equivalently, as the kinetic energy has no first-order contribution,
\begin{equation}
 \Delta H^{KS}(\mathbf{x})=\Delta V^{KS}(\mathbf{x})=\Delta V_{ext}(\mathbf{x})+\Delta V_{H}(\mathbf{x})+\Delta V_{xc}(\mathbf{x}.)
\end{equation}
The combination of Eqs. \ref{sternheimer1}, \ref{sternheimer2}, and \ref{sternheimer3} forms a set of equations for the perturbed system that can be solved in a self-consistent way. The formalism we have 
described can give the derivatives of the density that we need to calculate the dynamical matrices and it is implemented in the $Quantum$ $Espresso$ software package\cite{giannozzi2009quantum}.

\section{Phonons from the finite displacements method}
\label{finite_displacement}

In this section we will see how we can calculate the 2BFC just by calculating the forces given by the 
Hellman-Feynman theorem in different supercells. In the harmonic approximation the $\alpha_{1}$ Cartesian component 
of the force exerted on the atom at position 
$\mathbf{R}_{s_{1}}(\mathbf{T}_{1})$ is 
\begin{equation}
f_{s_{1}}^{\alpha_{1}}(\mathbf{T}_{1})=-\sum_{\mathbf{T}_{2}s_{2}\alpha_{2}}\phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(
\mathbf{T}_{1},\mathbf{T}_{2})u_{s_{2}}^{\alpha_{2}}(\mathbf{T}_{2}),
 \label{forces_formula}
\end{equation}
We can arrive to that expression just by taking the derivative of Eq. \ref{harmonic_hamiltonian}. The 2BFC can be 
calculated as
\begin{equation}
	\phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})=-\frac{\partial f_{s_{1}}^{\alpha_{1}}(\mathbf{T}_{1})}{\partial u_{s_{2}}^{\alpha_{2}}(\mathbf{T}_{2})}\simeq -\frac{f_{s_{1}}^{\alpha_{1}}[u_{s_{2}}^{\alpha_{2}}](\mathbf{T}_{1})}{u_{s_{2}}^{\alpha_{2}}},
 \label{forward}
\end{equation}
by displacing once at a time all the atoms of the lattice along the three Cartesian components by 
$u_{s_{2}}^{\alpha_{2}}(\mathbf{T}_{2})$, and calculating the forces 
$f_{s_{1}}^{\alpha_{1}}[u_{s_{2}}^{\alpha_{2}}](\mathbf{T}_{1})$ induced on the atom at $\mathbf{R}_{s_{1}}(\mathbf{T}_{1})$. Eq. \ref{forward} computes the 2BFC using forward differences. For numerical reasons it can be advantageous in some cases to use central differences. \\

Since the crystal is invariant under translations of any lattice vector, it is only necessary to displace atoms in 
one primitive cell and calculate the forces induced on all the other atoms of the crystal. From now on we will 
assume that this is understood and put simply $\mathbf{T}_{2}=0$. \\

It is important to point that the 2BFC 
$\phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})$ in Eq. \ref{perturbative-nbfc} are the 
2BFC in the infinite lattice. Therefore, there is no restriction on the lattice vectors $\mathbf{T}$. However, the 
calculation of the 2BFC expressed in Eqs. \ref{forces_formula} and \ref{forward} can only be done in supercell 
geometry. Using the supercell geometry we can only calculate the dynamical matrices at wavevectors that are 
reciprocal lattice vectors of the superlattice, so, without further approximations the calculation of the infinite 
lattice 2BFC is impossible. \\

Our assumption will be the following: the infinite lattice 2BFC 
$\phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})$ vanishes when the separation 
$|\mathbf{R}_{s_{1}}(\mathbf{T}_{1})-\mathbf{R}_{s_{2}}(\mathbf{T}_{2})|$ is such that the positions 
$\mathbf{R}_{s_{1}}(\mathbf{T}_{1})$ and $\mathbf{R}_{s_{2}}(\mathbf{T}_{2})$ lie in different Wigner-Seitz (WS) 
cells\cite{ashcroft1976solid} of the chosen superlattice. Mathematically speaking, we are assuming that if we 
take the WS cell centered on $\mathbf{R}_{s_{2}}(\mathbf{T}_{2})$, then the infinite lattice value of the 2BFC 
$\phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})$ is equally zero if 
$\mathbf{R}_{s_{1}}(\mathbf{T}_{1})$ is in a different WS cell; it is equal to the supercell value if 
$\mathbf{R}_{s_{1}}(\mathbf{T}_{1})$ is within the same WS cell; and it is equal to the supercell value divided by 
an integer $P$ if $\mathbf{R}_{s_{1}}(\mathbf{T}_{1})$ lies on the boundary of the same WS cell, where $P$ 
is the number of WS cells having $\mathbf{R}_{s_{1}}(\mathbf{T}_{1})$ on their boundary. With this assumption, the 
2BFC will converge to the correct infinite lattice values as the size of the supercell systematically increases. \\

So far we have described a method to properly converge the 2BFC to the infinite lattice 2BFC by calculating the 
forces in different supercell sizes. For that purpose, we need to move all the atoms one by one in the three Cartesian directions and calculate the resulting forces in all the other atoms. This procedure gives a number of displacements for which, the forces must be computed. The number of displacements can be reduced by using the symmetries of the system. The symmetries include: translations, permutations, and space group symmetry operations. By using these symmetries many elements of the 2BFC matrix can be related, therefore, it is not necessary to calculate all of them explicitly. \\ 

For example, let's take the case of space group symmetries $S$ and imagine we calculate the 2BFC 
$\phi_{s1}(\mathbf{T}, 0)$. Then, if the atom $1$ and $2$ are related by the symmetry 
operation $S$, we can write 
\begin{equation}
\label{symm}
\boldsymbol{\phi}_{s2}(\mathbf{T},0)=\mathbf{B}(S)\boldsymbol{\phi}_{\lambda_{s_{1}}(S)1}(\mathbf{T},0)\mathbf{B}(S^{-1}),
\end{equation}
where $\mathbf{B}(S)$ is the $3\times3$ matrix representing the point group part of $S$ in Cartesian coordinates and 
$\lambda_{s}(S)$ indicates the atom of the crystal where the atom $\mathbf{R}_{s}(\mathbf{T})$ is brought because of 
the action of the symmetry operation $S$. In Eq. \ref{symm} we have made use of the matrix notation by using bold symbols. This procedure is repeated then for all the atoms of the primitive cell. A similar procedure can be applied for the translational symmetry and the permutation symmetry of the 2BFC. \\

%However, it is not always necessary to 
%displace all the atoms in the primitive cell, since the use of symmetries can simplify this task. If there is a 
%symmetry operation $S$ that relates two atomic positions in the primitive cell and the whole crystal is invariant 
%under such transformation, then it is not necessary to move both atoms. Imagine we calculate the 2BFC 
%$\phi_{s1}(\mathbf{T}, 0)$. Then, if the atom $1$ and $2$ are related by the symmetry 
%operation $S$, we can write 
%\begin{equation}
%	\phi_{s2}(\mathbf{T},0)=\mathbf{B}(S)\phi_{\lambda_{s_{1}}(S)1}(\mathbf{T},0)\mathbf{B}(S^{-1}),
%\end{equation}
%where $\mathbf{B}(S)$ is the $3\times3$ matrix representing the point group part of $S$ in Cartesian coordinates and 
%$\lambda_{s}(S)$ indicates the atom of the crystal where the atom $\mathbf{R}_{s}(\mathbf{T})$ is brought because of 
%the action of the symmetry operation $S$. This procedure is repeated then for all the atoms of the primitive cell. \\

%In principle each atom has to be displaced along the three Cartesian directions. It is sometimes convenient to
%displace the atoms along some special directions so as to maximize the number of symmetry operations still present 
%in the perturbed (once the atoms displaced) supercell. \\

%Using symmetries it is possible to reduce the number of displacementsr. If applying a point group 
%symmetry operation $W$ to the displacement vector $\mathbf{u}_{1}$ one obtains a vector $\mathbf{u}_{2}$ which is 
%linearly independent from $\mathbf{u}_{1}$, then the force field that would be induced by the displacement 
%$\mathbf{u}_{2}$ can be calculated by 
%\begin{equation}
%\mathbf{f}_{s_{1}s_{2}}^{2}(\mathbf{T}_{1},0)=\mathbf{B}(W)\mathbf{f}_{\lambda_{s_{1}}(W^{-1}),s_{2}}^{1}(\mathbf{T}_{1},0).
%\end{equation}
%$\mathbf{f}_{s_{1}s_{2}}^{2}(\mathbf{T}_{1},0)$ is the force on atom $\mathbf{R}_{s_{1}}(\mathbf{T}_{1})$ when 
%applied displacement $\mathbf{u}_{2}$ to atom $\mathbf{R}_{s_{2}}(0)$.
%If we can not find a linearly independent displacement using the previous idea one has to displace the atom along a 
%chosen independent direction and perform another calculation. This must be done until a set of three independent 
%directions is found. \\

%In principle, well defined 2BFC are invariant under the point group symmetry operations of the 
%crystal. However, this is not automatically guaranteed by the procedure we have just described, because in general, 
%the crystal is not harmonic and therefore Eq. \ref{forward} is only an approximation. So, the 2BFC must be 
%symmetrized with respect to the point group operations of the crystal
%\begin{equation}
%\phi_{s_{1}s_{2}}(\mathbf{T}_{1},0)=\frac{1}{N_{W}}\sum_{W}\mathbf{B}(W)\phi_{\lambda_{s_{1}}(W),s_{2}}(\mathbf{T}_{1},0)\mathbf{B}(W)^{-1},
%\end{equation}
%$N_{W}$ being the number of point group operations. 

The symmetrization of the 2BFC removes all even-order anharmonicities. It must be pointed, that the harmonic 
approximation becomes better and better as the displacement are made smaller and smaller. However, this can 
not be taken to the limit because the smaller are the displacements the smaller are the induced forces and the level 
of accuracy is always finite. So, one can not make too small displacements but usually a fraction of a percentage of 
the nearest neighbour distance is a good compromise. \\

\section{Long-wavelength vibrations in polar materials}

The formalisms we have described so far are general for metals and insulators and allow the calculation of phonon 
frequencies and polarization vectors at any $\mathbf{q}$ point of the 1BZ. However, in polar semiconductors and 
insulators, the long-range character of the Coulomb forces gives rise to macroscopic electric fields for longitudinal 
optic (LO) phonons in the long-wavelength limit. In this limit, phonons are coupled to these macroscopic electric 
fields and their energy is shifted. \\

The physics of the system can be understood within the Huang's phenomenological model\cite{born1954dynamical} for a cubic lattice with two atoms per unit cell and easily generalized for any kind of lattice. This is 
just a simple model to understand the physics behind this effect. The most general quadratic expression of the energy as a function of the phonon optic coordinates $\mathbf{u}$ and the electric field $\boldsymbol{\mathsf{E}}$ is
\begin{equation}
 E(\mathbf{u},\boldsymbol{\mathsf{E}})=\frac{1}{2}m\omega_{0}^{2}u^{2}-\frac{\Omega_{cell}}{8\pi}\epsilon_{\infty}-Z^{*}\mathbf{u}\cdot\boldsymbol{\mathsf{E}},
\end{equation}  
where $m$ is the nuclear reduced mass (defined as $m=m_{1}m_{2}/(m_{1}+m_{2})$ for two masses $m_{1}$ and $m_{2}$), $\epsilon_{\infty}$ the electronic dielectric constant of the crystal (the static dielectric constant 
with $\mathbf{u}=0$), $\omega_{0}$ the frequency of the mode without taking into account the coupling to the electric field, $\Omega_{cell}$ is the volume of the unit cell, and the coupling $Z^{*}$, between the atomic 
displacements and the electric field, is known as the Born effective charge of the ions. The conjugate variables to $\mathbf{u}$ and $\boldsymbol{\mathsf{E}}$ are the force $\mathbf{f}$ acting on the ions and the electrical 
induction $\boldsymbol{\mathsf{D}}$
\begin{equation}
 \label{conjugate-force}
 \mathbf{f}\equiv -\frac{\partial E}{\partial\mathbf{u}}=-m\omega_{0}^{2}\mathbf{u}+Z^{*}\boldsymbol{\mathsf{E}},
\end{equation}
\begin{equation}
 \label{conjugate-field}
	\boldsymbol{\mathsf{D}}\equiv -\frac{4\pi}{\Omega_{cell}}\frac{\partial E}{\partial \boldsymbol{\mathsf{E}}}=\frac{4\pi}{\Omega_{cell}}Z^{*}\mathbf{u}+\epsilon_{\infty}\boldsymbol{\mathsf{E}}.
\end{equation}

In the absence of free external charges, Maxwell's equations give
\begin{equation}
 \label{rotational}
\boldsymbol{\nabla}\times\boldsymbol{\mathsf{E}}\sim i\mathbf{q}\times\boldsymbol{\mathsf{E}}=0,
\end{equation}
\begin{equation}
 \label{divergency}
\boldsymbol{\nabla}\cdot\boldsymbol{\mathsf{D}}\sim i\mathbf{q}\cdot\boldsymbol{\mathsf{D}}=0.
\end{equation}
For transverse modes, where the electric field is perpendicular to the phonon momentum, Eq. \ref{rotational} gives $\boldsymbol{\mathsf{E}}_{T}=0$ ($\boldsymbol{\mathsf{E}}_{T}$ is the transversal component of the electric 
field), and Eq. \ref{conjugate-force} $\mathbf{f}_{T}=-m\omega_{0}^{2}\mathbf{u}$. Therefore the transverse frequency is $\omega_{T}=\omega_{0}$. For longitudinal modes, where the electric field is parallel to the phonon 
momentum, Eq. \ref{divergency} gives $\boldsymbol{\mathsf{D}}_{L}=0$ and Eq. \ref{conjugate-field} gives $\boldsymbol{\mathsf{E}}_{L}=-4\pi Z^{*}/(\Omega_{cell}\epsilon_{\infty})\mathbf{u}$ ($\boldsymbol{\mathsf{E}}_{L}$ is the 
longitudinal component of the electric field). Eq. \ref{conjugate-force} gives $\mathbf{f}_{L}=-(m\omega_{0}^{2}+4\pi Z^{*2}/(\Omega_{cell}\epsilon_{\infty}))\mathbf{u}$. Therefore, the longitudinal frequency 
is $\omega_{L}=\sqrt{\omega_{0}^{2}+4\pi Z^{*2}/(\Omega_{cell}\epsilon_{\infty}m)}$. These results clearly show that the frequency of longitudinal modes in the long-wavelength limit have an extra term that arises due to the 
coupling with the electric field. The formalism can be generalized for crystals with any symmetry and in these cases the Born effective charges and the electronic dielectric constant will be tensors. \\

If we want to define the 2BFC in the long-wavelength limit, they can be split into the sum of an analytic and a nonanalytic contributions
\begin{equation}
 \phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}=\overset{an}{\phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}}+\overset{na}{\phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}},
\end{equation}
where the analytic part is the matrix obtained from DFPT, for instance, the perturbation being a zone-center phonon displacement at zero macroscopic electric field. The nonanalytic part has the general form
\begin{equation}
\label{nonanalytic}
\overset{na}{\phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}}=\frac{4\pi}{\Omega_{cell}}\frac{(\mathbf{q}\cdot\mathbf{Z}^{*}_{s_{1}})_{\alpha_{1}}(\mathbf{q}\cdot\mathbf{Z}^{*}_{s_{2}})_{\alpha_{2}}}{\mathbf{q}\cdot\boldsymbol{
\epsilon}_{\infty}\cdot\mathbf{q}}.
\end{equation}
From Eq. \ref{nonanalytic} we can see that for the nonanalytic part of the 2BFC at $\mathbf{q}=0$ we need the macroscopic dielectric constant of the system and the Born effective charges, which can be calculated within
the DFPT formalism explained in section \ref{dfpt-2bfc}\cite{gonze1997dynamical}. \\

In order to have a little bit of intuition on how to calculate these quantities, the first-principles calculation of $\epsilon_{\infty}^{\alpha\beta}$ and $Z_{s}^{*\alpha\beta}$ can be started from the definition of the macroscopic electric polarization of the medium, 
\begin{equation}
 \mathsf{P}_{\alpha}=\frac{1}{\Omega_{cell}}\sum_{s\beta}\left[Z^{*\alpha\beta}_{s}u_{s}^{\beta}+\frac{\epsilon_{\infty}^{\alpha\beta}-\delta_{\alpha\beta}}{4\pi}\mathsf{E}_{\beta}\right],
\end{equation}
$\delta_{\alpha\beta}$ being the Kronecker delta. The macroscopic polarization definition must be read as a tensor equation stating that the Born effective charge tensor of the $s$th ion with respect to a periodic displacement of 
all the ions of the s species at zero macroscopic electric field
\begin{equation}
 Z^{*\alpha\beta}_{s}=\Omega_{cell}\frac{\partial \mathsf{P}_{\alpha}}{\partial u_{s}^{\beta}(\mathbf{q}=0)}\vline_{_{_{_{_{_{_{_{\boldsymbol{\mathsf{E}}=0}}}}}}}},
\end{equation}
while the electronic dielectric constant tensor is the derivative of the polarization with respect to the macroscopic electric field at clamped ions
\begin{equation}
 \epsilon_{\infty}^{\alpha\beta}=\delta_{\alpha\beta}+4\pi\frac{\partial\mathsf{P}_{\alpha}}{\partial\mathsf{E}_{\beta}}\vline_{_{_{_{_{_{_{_{\mathbf{u}_{s}(\mathbf{q}=0)=0}}}}}}}}.
\end{equation}
\\

For a better understanding, in Fig. \ref{LOTOsplitting} we show the ab initio phonon spectrum of $SnS$.
\begin{figure}[h]
\begin{center}
\includegraphics[width=0.9\linewidth]{Figures/charges.eps}
\caption[$SnS$ phonon spectrum]{Ab initio phonon dispersion of $SnS$ including the coupling of the longitudinal optic modes with the macroscopic electric field (black circles) and without including it (red lines). The LO modes are denoted with arrows.}
\label{LOTOsplitting}
\end{center}
\end{figure}
As we can see, in practice, the correction for the longitudinal optic modes in the long-wavelentgh limit translates into a different gap between the longitudinal and transverse modes for different directions in the 1BZ. The reason 
is that for different directions in the 1BZ the frequency of the longitudinal modes is different.

\section{Anharmonic effects in solids}
The harmonic approximation allows to diagonalize the ionic Hamiltonian and, therefore, provides well defined 
quasiparticles named phonons which do not interact among themselves. For that purpose 
we have seen that we need to truncate the Taylor expansion of the external potential at the second-order within the small atomic displacements assumption. This assumption seems to be valid in most solids 
for temperatures below the melting point, specially for obtaining phonon frequencies and its associated physical properties\cite{born1954dynamical}. However, the non-interacting picture has limitations and it 
is not able to explain many physical phenomena that arise due to the anharmonic terms in Eq. \ref{taylor-expansion}. Probably, one of the most representative examples of anharmonicity is the non-zero thermal 
resistivity of materials which is translated into a finite thermal conductivity. Within the harmonic approximation the phonon basis diagonalizes the Hamiltonian and, therefore, if the system is in an eigenstate 
it will stay there forever. This means that the lifetime of these states is infinite and they can carry thermal energy without any resistance. In reality, obviously, solids have a finite thermal conductivity. 
It is also well known that the peaks observed in neutron scattering experiments have a measurable width, which is inversely proportional to the lifetime of a phonon. The harmonic approximation is also unable 
to describe more basic properties such as the temperature dependence of phonon frequencies and the thermal expansion of solids. \\ 

Anharmonicity can be treated within perturbation theory by calculating higher-order terms of the Taylor expansion of the BOES. This approximation holds when the anharmonic coefficients of the Taylor expansion 
are much smaller than the harmonic ones. This means that the potential can be described with the second-order term of the Taylor expansion of the BOES in the range defined by the ionic fluctuations and anharmonic 
terms are just a small correction. It can be the case that ionic displacements cannot be considered small anymore and higher-order terms become as important as, or even more than, the second-order 
ones. The origin of such big displacements can be temperature when a solid is close to melting. It can also happen that at low temperatures or even at $0$ K the harmonic and perturbative regimes break down in the 
presence of very light atoms\cite{borinaga2017anharmonicity} or when the crystal is close to dynamical instabilities, as it happens in 
ferroelectrics\cite{ribeiro2018strong,zhang2011anomalous} or in materials that show charge density wave transitions\cite{kidd2002electron,leroux2015strong}. \\

When perturbation theory breaks down one needs to apply nonpertubative methods. One way of including anharmonic effects at a nonpertubative level is to use molecular dynamics 
simulations\cite{hellman2013temperature,hellman2013temperature1,hellman2011lattice,ljungberg2013temperature,magduau2013identification,wang1990tight,zhang2014phonon,de2009thermal}. This method usually requires long simulation
times and, as it follows Newtonian dynamics, its applications are limited to temperatures above the Debye temperature. The Newtonian limitation can be overcome by applying path integral molecular 
dynamics\cite{ceperley1995path} which are even more computationally expensive as they require to simulate the quantum fluctuations. There is another family of 
methods\cite{errea2014anharmonic,errea2013first,errea2011anharmonic,monserrat2013anharmonic,tadano2015self,georgescu2012self,brown2013self,patrick2015anharmonic,} that have been developed mainly inspired by the 
self-consistent harmonic approximation (SCHA) formulated by Hooton\cite{hooton1955li}. The SCHA uses the variational Gibbs-Bogoliubov (GB) principle to approximate the free energy of the ionic Hamiltonian with 
the free energy calculated with a trial harmonic density matrix for the same system, which does not coincide with the harmonic density matrix obtained from the harmonic approximation. \\

In this thesis we have applied the perturbative method\cite{paulatto2013anharmonic} and a stochastic implementation of the SCHA, the so called stochastic self-consistent 
harmonic approximation (SSCHA)\cite{errea2013first,errea2014anharmonic,bianco2017second,monacelli2018pressure}. In 
the following sections we will discuss both of them.

\section{Perturbation theory of the phonon-phonon interaction}
\label{perturbation-theory-third}

In this section we will see what is the correction that the lowest-order perturbation theory makes to the harmonic 
result. We will see that this approximation not only gives an anharmonic line shift to the harmonic 
frequencies, but also an anharmonic line width, which makes clear that the phonons do not diagonalize the anharmonic Hamiltonian and they will no longer have an infinite lifetime. Therefore, this 
theory will allow us to calculate properties, such as, the lattice thermal conductivity and the phonon spectral function measured in inelastic scattering experiments. \\

We will name the harmonic Hamiltonian $H^{(0)}$ and we will treat the anharmonic part as a small perturbation of $H^{(0)}$. With $G_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2};z)$ and 
$G_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}(0)}(\mathbf{T}_{1},\mathbf{T}_{2};z)$ we indicate the Green's functions of the total ionic Hamiltonian $H^{I}$ and $H^{(0)}$ for the variable $\sqrt{m_{s}}u_{s}^{\alpha}(\mathbf{T})$, 
respectively. We define the Green's function in time space as $\overset{-1}{G}{}_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}(0)}(\mathbf{T}_{1},\mathbf{T}_{2};t)=\langle\sqrt{m_{s_{1}}}u_{s_{1}}^{\alpha_{1}}(\mathbf{T_{1}},0)\sqrt{m_{s_{2}}}u_{s_{2}}^{\alpha_{2}}(\mathbf{T_{2}},t)\rangle$.The Green's function of the Harmonic Hamiltonian is given by
\begin{equation}
 \overset{-1}{G}{}_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}(0)}(\mathbf{T}_{1},\mathbf{T}_{2};z)=z^{2}\delta_{s_{1}s_{2}}\delta_{\alpha_{1}\alpha_{2}}\delta_{\mathbf{T}_{1}\mathbf{T}_{2}}-D_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{
 T}_{1},\mathbf{T}_{2}).
\end{equation}
The relation between the full and harmonic Green's functions is given by the Dyson equation
\begin{equation}
 \label{green-function}
 \overset{-1}{\mathbf{G}}(z)=\overset{-1}{\mathbf{G}}{}^{(0)}(z)-\boldsymbol{\Pi}^{(0)}(z),
\end{equation}
which is equivalent to
\begin{equation}
 \label{dyson-eq}
 \mathbf{G}(z)=\mathbf{G}^{(0)}(z)+\mathbf{G}^{(0)}(z)\boldsymbol{\Pi}^{(0)}(z)\mathbf{G}(z).
\end{equation}
In the previous equations we have used the matrix notation and we use bold symbols to emphasize it. In Fig. \ref{dyson} we show the diagrammatic representation of Eq. \ref{dyson-eq}. 
\begin{figure}[h]
\begin{center}
\includegraphics[width=0.95\linewidth]{Figures/dyson.pdf}
\caption[Diagramatic representation of Dyson equation]{Diagrammatic representation of the Dyson equation in Eq. \ref{dyson-eq}. The dashed line corresponds to the harmonic propagator. The double solid 
line corresponds to the full propagator.}
\label{dyson}
\end{center}
\end{figure}
With $\boldsymbol{\Pi}^{(0)}(z)$ we denote the harmonic self-energy, the self-energy obtained by taking $H^{(0)}$ as 
noninteracting unperturbed Hamiltonian. At the lowest perturbative order, the harmonic self-energy can be written as
\begin{equation}
\label{self-energy}
\boldsymbol{\Pi}^{(0)}(z)\simeq\overset{(T)}{\boldsymbol{\Pi}}{}^{(0)}+\overset{(L)}{\boldsymbol{\Pi}}{}^{(0)}+\overset{(B)}{\boldsymbol{\Pi}}{}^{(0)}(z),
\end{equation}
where $\overset{(T)}{\boldsymbol{\Pi}}{}^{(0)}$, $\overset{(L)}{\boldsymbol{\Pi}}{}^{(0)}$, and $\overset{(B)}{\boldsymbol{\Pi}}{}^{(0)}(z)$ are the loop, tadpole and bubble harmonic self-energies, respectively, which have the 
following expressions
\begin{equation}
 \label{loop-diagram}
 \overset{(L)}{\Pi}{}_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}(0)}(\mathbf{T}_{1},\mathbf{T}_{2})=-\frac{1}{2}\sum\limits_{\substack{s_{3}s_{4} \\ \alpha_{3}\alpha_{4} \\ \mathbf{T}_{3},\mathbf{T}_{4}}}
 \overset{(4)}{D}{}^{\alpha_{1}\alpha_{2}\alpha_{3}\alpha_{4}}_{s_{1}s_{2}s_{3}s_{4}}(\mathbf{T}_{1},\mathbf{T}_{2},\mathbf{T}_{3},\mathbf{T}_{4})\left[\frac{1}{\beta}\sum_{l}G_{s_{3}s_{4}}^{\alpha_{3}\alpha_{4}(0)}(
 \mathbf{T}_{3},\mathbf{T}_{4};i\eta_{l})\right],
\end{equation}
\begin{multline}
 \label{tadpole-diagram}
 \overset{(T)}{\Pi}{}^{\alpha_{1}\alpha_{2}(0)}_{s_{1}s_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})=-\frac{1}{2}\sum\limits_{\substack{s_{3}s_{4}s_{5}s_{6} \\ \alpha_{3}\alpha_{4}\alpha_{5}\alpha_{6} \\ \mathbf{T}_{3},\mathbf{T}_{4},
 \mathbf{T}_{5},\mathbf{T}_{6}}}\overset{(3)}{D}{}_{s_{1}s_{3}s_{4}}^{\alpha_{1}\alpha_{3}\alpha_{4}}(\mathbf{T_{1},\mathbf{T}_{3},\mathbf{T}_{4}})G_{s_{3}s_{4}}^{\alpha_{3}\alpha_{4}(0)}(\mathbf{T}_{3},\mathbf{T}_{
 4};0) \\ \times\overset{(3)}{D}{}_{s_{2}s_{5}s_{6}}^{\alpha_{2}\alpha_{5}\alpha_{6}}(\mathbf{T}_{2},\mathbf{T}_{5},\mathbf{T}_{6})\left[\frac{1}{\beta}\sum_{l}G_{s_{5}s_{6}}^{\alpha_{5}\alpha_{6}(0)}(\mathbf{T}_{5},\mathbf{T}_{
 6};i\eta_{l})\right],
\end{multline}
\begin{multline}
 \label{bubble-diagram}
 \overset{(B)}{\Pi}{}_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}(0)}(\mathbf{T}_{1},\mathbf{T}_{2};z)=-\frac{1}{2}\sum\limits_{\substack{s_{3}s_{4}s_{5}s_{6} \\ \alpha_{3}\alpha_{4}\alpha_{5}\alpha_{6} \\ \mathbf{T}_{3},\mathbf{T}_{4},
 \mathbf{T}_{5},\mathbf{T}_{6}}}\overset{(3)}{D}{}_{s_{1}s_{3}s_{4}}^{\alpha_{1}\alpha_{3}\alpha_{4}}(\mathbf{T}_{1},\mathbf{T}_{3},\mathbf{T}_{4})\overset{(3)}{D}{}_{s_{2}s_{5}s_{6}}^{\alpha_{2}\alpha_{5}\alpha_{6}}(\mathbf{
 T}_{2},\mathbf{T}_{5},\mathbf{T}_{6}) \\ \times\left[\frac{1}{\beta}\sum_{l}G_{s_{3}s_{4}}^{\alpha_{3}\alpha_{4}(0)}(\mathbf{T}_{3},\mathbf{T}_{4};i\eta_{l})G_{s_{5}s_{6}}^{\alpha_{5}\alpha_{6}(0)}(\mathbf{T}_{5},\mathbf{
 T}_{6};z-i\eta_{l})\right].
\end{multline}
In these expressions we have generalized the definition of the harmonic dynamical matrix to the $n$th order (for the second-order we omit the index $(2)$)
\begin{equation}
 \overset{(n)}{D}{}_{s_{1}\dots s_{n}}^{\alpha_{1}\dots\alpha_{n}}(\mathbf{T}_{1},\dots,\mathbf{T}_{n})=\frac{\overset{(n)}{\phi}{}_{s_{1}\dots s_{n}}^{\alpha_{1}\dots\alpha_{n}}(\mathbf{T}_{1},\dots,\mathbf{T}_{n})}{\sqrt{
 m_{s_{1}}\dots m_{s_{n}}}},
\end{equation}
and $\eta_{l}=2\pi l/\beta$ is the $l$th Matsubara frequency\cite{maradudin1962scattering}. In Fig. \ref{self-energy-fig} we include the diagrammatic representations of the self-energy and Feynman diagrams of the 
tadpole, loop, and bubble self-energies.
\begin{figure}[h]
\begin{center}
\includegraphics[width=0.95\linewidth]{Figures/self-energy.pdf}
\caption[Diagramatic representation of the self-energy]{Diagrammatic representation of the self-energy and Feynman diagrams for the tadpole, loop, and bubble self-energies. The dashed line corresponds to the harmonic 
phonons and dots represent the interaction vertices. Within perturbation theory at the lowest-order there are third and fourth-order vertices, which means that there are three and four phonon interactions.}
\label{self-energy-fig}
\end{center}
\end{figure}
\\

Note that the loop and tadpole self-energy terms do not depend on the frequency $z$ and they are real. The tadpole self-energy can be divided into optical and acoustic contributions. The tadpole optical $T_{O}$ diagram includes 
the effect of an optical phonon at the $\Gamma$ point and it accounts for the relaxation of internal coordinates due to anharmonic effects. If internal atomic coordinates are fixed by symmetry, the $T_{O}$ diagram vanishes and 
does not contribute\cite{calandra2007anharmonic}. On the contrary, if Wyckoff positions have free parameters\cite{aroyo2011crystallography}, the $T_{O}$ diagram accounts for the effect of quantum and thermal fluctuations in the 
internal coordinates. An alternative way of accounting for the $T_{O}$ diagram is to minimize the free energy within the quasiharmonic approximation (QHA)\cite{bonini2007phonon}. For the internal coordinates that minimize the 
free energy within the QHA the $T_{O}$ diagram vanishes. These equilibrium atomic positions might be different from $\mathbf{R}^{0}$ obtained from the minimum of the BOES. The $T_{A}$ diagram includes the effect of an acoustic 
phonon in the limit of $\mathbf{q}\rightarrow\Gamma$ and accounts for the cell parameters relaxation. It can also be calculated within the QHA.  
\\

From $\boldsymbol{G}(z)$ we can calculate the one-phonon spectral function as \\ $\tilde{\sigma}=-2ImTr[\boldsymbol{G}(\omega+i0^{+})]$. Note that in the previous expression we have applied the change $z\rightarrow\omega+i0^{+}$. Peaks in the spectral function as a function of $\omega$ signal the presence of 
collective vibrational excitations, phonon quasiparticles, having certain energies. The sharper are the peaks the more lasting are these quasiparticles, their lifetime being inversely proportional to the width. A broad 
spectral function means that anharmonicity has removed the existence of quasiparticles with definite identity. This kind of information can be probed with inelastic scattering experiments, for example.  \\ 

We take advantage of the lattice periodicity also in this case and, Fourier transforming with respect to lattice indices, we consider separated spectral functions $-2ImTr[\boldsymbol{G}(\boldsymbol{q},\omega+i0^{+})]$ for 
each $\boldsymbol{q}$ point in the 1BZ. We find convenient to multiply the spectral function by $\omega/2\pi$
\begin{equation}
\label{sigma-nodiagonal}
\tilde{\sigma}(\mathbf{q},\omega)=-\frac{\omega}{\pi}ImTr[\omega^{2}\boldsymbol{1}-\mathbf{D}(\mathbf{q})-\boldsymbol{\Pi}(\mathbf{q},\omega+i0^{+})]^{-1},
\end{equation}
because its $\omega$ integral over the real axis gives the total number of modes and, in the zero self-energy case, it gives equal Dirac's delta peaks at the non-interacting harmonic phonon frequencies. Evaluating the 
phonon spectral function through Eq. \ref{sigma-nodiagonal} requires the inversion of a matrix. If the mode mixing can be neglected, we can get a diagonal self-energy by applying the following transformation
\begin{equation}
\Pi_{\mu}(\mathbf{q},\omega)=\sum\limits_{\substack{s_{1}s_{2} \\ \alpha_{1}\alpha_{2}}}\epsilon_{\mu s_{1}}^{\alpha_{1}}(\mathbf{q})\Pi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{q},\omega+i0^{+})\epsilon_{
 \mu s_{2}}^{\alpha_{2}}(\mathbf{q}).
\end{equation}
The spectral function is then given by
\begin{multline}
\label{cross-section-new}
\tilde{\sigma}(\mathbf{q},\omega)=\sum_{\mu}\frac{1}{2}\left[\frac{1}{\pi}\frac{-Im\mathcal{Z}_{\mu}(\mathbf{q},\omega)}{[\omega-Re\mathcal{Z}_{\mu}(\mathbf{q},\omega)]^{2}+[Im\mathcal{Z}_{\mu}(\mathbf{q},\omega)]^{
2}}\right]+\\\sum_{\mu}\frac{1}{2}\left[\frac{1}{\pi}\frac{Im\mathcal{Z}_{\mu}(\mathbf{q},\omega)}{[\omega+Re\mathcal{Z}_{\mu}(\mathbf{q},\omega)]^{2}+[Im\mathcal{Z}_{\mu}(\mathbf{q},\omega)]^{2}}\right]
\end{multline}
with $\mathcal{Z}_{\mu}(\mathbf{q},\omega)=\sqrt{\omega_{\mu}^{2}(\mathbf{q})+\Pi_{\mu}(\mathbf{q},\omega+i0^{+})}$, where we consider the positive value of the square root.  
The spectral function calculated in Eq. \ref{cross-section-new} does not have any given line shape. \\

%Depending on the line shape of the spectral function we can divide the phonon quasiparticles into three groups: harmonic, weakly 
%anharmonic and strongly or full anharmonic materials. In Fig. \ref{instoy} we qualitatively describe the cross section of the three groups.
The equations given by perturbation theory only hold when the corrections to the harmonic frequencies are much smaller than the harmonic value. In this case $\Pi_{\mu}(\mathbf{q},\omega)$ is small compared to $\omega_{\mu}^{2}(\mathbf{q})$ and it is justified to approximate 
$\Pi_{\mu}(\mathbf{q},\omega)\sim\Pi_{\mu}(\mathbf{q},\omega_{\mu}(\mathbf{q}))$, which turns $\tilde{\sigma}(\mathbf{q},\omega)$ into a sum of Lorentzian functions. 
\begin{multline}
 \tilde{\sigma}(\mathbf{q},\omega)=\sum_{\mu}\frac{1}{2}\left[\frac{1}{\pi}\frac{\Gamma_{\mu}(\mathbf{q})}{[\omega-\omega_{\mu}(\mathbf{q})-\Delta_{\mu}(\mathbf{q})]^{2}+[\Gamma_{\mu}(\mathbf{q})]^{2}}\right]\\+\sum_{
 \mu}\frac{1}{2}\left[\frac{1}{\pi}\frac{\Gamma_{\mu}(\mathbf{q})}{[\omega+\omega_{\mu}(\mathbf{q})+\Delta_{\mu}(\mathbf{q})]^{2}+[\Gamma_{\mu}(\mathbf{q})]^{2}}\right],
\end{multline}
where
%\begin{equation}
% \Delta_{\mu}(\mathbf{q})=Re\mathcal{Z}_{\mu}(\mathbf{q},\omega_{\mu}(\mathbf{q}))-\omega_{\mu}(\mathbf{q}),
%\end{equation}
\begin{equation}
 \label{lineshift}
 \Omega_{\mu}(\mathbf{q})=Re\mathcal{Z}_{\mu}(\mathbf{q},\omega_{\mu}(\mathbf{q})),
\end{equation}
\begin{equation}
 \label{linewidth}
 \Gamma_{\mu}(\mathbf{q})=-Im\mathcal{Z}_{\mu}(\mathbf{q},\omega_{\mu}(\mathbf{q}))
\end{equation}
are the shifted frequency (with respect to the harmonic frequency) and half-width at half-maximum (HWHM) of mode 
$\mu$, respectively. In this limit, the lifetime of a phonon $\mu\mathbf{q}$ is defined as the inverse line width 
(full width at half maximum, FWHM)
\begin{equation}
\label{lifetime}
 \tau_{\mu}(\mathbf{q})=\frac{1}{2\Gamma_{\mu}(\mathbf{q})}.
\end{equation}
These are well defined phonons with their frequencies and line widths. 
In Fig. \ref{instoy} we qualitatively describe the Lorentzian cross section.
\begin{figure}[h]
\begin{center}
\includegraphics[width=0.9\linewidth]{Figures/ins-toy1.eps}
\caption[Lorentzian and harmonic spectral functions]{Lorentzian and harmonic spectral functions. The harmonic spectral function is a Dirac's delta. The Lorentzian has a well defined full width at half maximum (FWHM) and a well defined energy $\Omega_{\mu}(\boldsymbol{q})$.}
\label{instoy}
\end{center}
\end{figure}
We can see that anharmonicity within perturbation theory provides two anharmonic properties. A line shift with respect to the harmonic value $\Omega_{\mu}(\mathbf{q})-\omega_{\mu}(\mathbf{q})$ and a line width $2\Gamma_{\mu}(\mathbf{q})$ (FWHM), which does not exist within the harmonic theory. \\

As we can see from Eqs. \ref{loop-diagram}, \ref{bubble-diagram}, and \ref{tadpole-diagram} in order to account for the phonon-phonon interactions at the lowest-order in perturbation theory we need to calculate 
the $\overset{(3)}{D}{}_{s_{1},s_{2},s_{3}}^{\alpha_{1}\alpha_{2}\alpha_{3}}(\mathbf{T}_{1},\mathbf{T}_{2},\mathbf{T}_{3})$ and $\overset{(4)}{D}{}_{s_{1}s_{1},s_{3}s_{4}}^{\alpha_{1}\alpha_{2}\alpha_{3}\alpha_{4}}(\mathbf{T}_{1},\mathbf{T}_{2},\mathbf{T}_{3},\mathbf{T}_{4})$ anharmonic dynamical matrices. The straightforward way of calculating these 
coefficients is to apply finite differences in the BOES\cite{li2014shengbte} as explained in section 
\ref{finite_displacement} for the second-order. However, this method requires calculation in supercells that are 
commensurate with the phonons that interact, therefore, they require calculations in big supercells in order to 
achieve convergence. Furthermore, the number of elements to be determined is huge, complicating the finite difference 
approach. An alternative, and more elegant, procedure for the third-order anharmonic coefficients is to apply the 
$2n+1$ theorem\cite{gonze1989density} which allows to get the $(2n+1)^{th}$ derivatives of the BOES with the 
knowledge of the $n^{th}$ derivatives of the electronic density. The latter method is more complicated to 
implement\cite{paulatto2013anharmonic} but allows to make the calculations in the unit cell independently of the 
modes that are considered.  

\section{The stochastic self-consistent harmonic approximation}
\label{sscha-basics}

The perturbative formalism we have described in section \ref{perturbation-theory-third} assumes that phonons can be described as distinct particles. This assumption is only valid when the anharmonic self-energy is 
small compared to the separation between harmonic frequencies. There is one extreme case in which perturbation theory cannot be even applied, it is when there are imaginary frequencies within the harmonic approximation, which 
means that the system is unstable within this approximation. \\

A formalism that can be applied in the cases where perturbation theory fails, even in the cases where there are harmonic instabilities, is the variational approach defined by the self-consistent harmonic 
approximation (SCHA)\cite{hooton1955li}, which has been implemented in a stochastic framework in the so called 
stochastic self-consistent harmonic approximation 
(SSCHA)\cite{errea2013first,errea2014anharmonic,bianco2017second,monacelli2018pressure}. \\ 

The exact vibrational free energy of a solid is given by the sum of the total energy and entropic contributions
\begin{equation}
 F_{H}=tr(\rho_{H^{I}}H^{I})+\frac{1}{\beta}tr(\rho_{H^{I}}ln\rho_{H^{I}}),
\end{equation}
where $\rho_{H^{I}}=e^{-\beta H^{I}}/tr(e^{-\beta H^{I}})$ is the density matrix defined by the Hamiltonian $H^{I}$ of the system. In the SSCHA $\rho_{H^{I}}$ is substituted by a trial density matrix $\rho_{\mathcal{H}}$ defined 
by a trial Hamiltonian $\mathcal{H}=T_{I}+\mathcal{U}$ where $T_{I}$ is the true kinetic energy of the ions and $\mathcal{U}$ a trial potential. Then, we can define
\begin{equation}
 \mathcal{F}_{H^{I}}[\mathcal{H}]=tr(\rho_{\mathcal{H}}H^{I})+\frac{1}{\beta}tr(\rho_{\mathcal{H}}ln\rho_{\mathcal{H}}),
\end{equation}
and by the GB principle we know that
\begin{equation}
 F_{H^{I}}\le\mathcal{F}_{H^{I}}[\mathcal{H}].
\end{equation} 
By adding and subtracting $tr(\rho_{\mathcal{H}}\mathcal{H})$ we can rewrite $\mathcal{F}_{H^{I}}[\mathcal{H}]$ as
\begin{equation}
 \label{scha-equation}
 \mathcal{F}_{H^{I}}[\mathcal{H}]=F_{\mathcal{H}}+tr[\rho_{\mathcal{H}}(U-\mathcal{U})],
\end{equation}
where $\mathcal{F}_{H^{I}}[\mathcal{H}]$ is the function we need to minimize with respect to $\mathcal{H}$ in order to get a good approximation for the free energy of the system. The equations we have written so far are valid 
for any trial potential $\mathcal{U}$. The main idea behind the SSCHA is that $\mathcal{U}$ is taken to be a harmonic potential and can be parametrized as
\begin{equation}
 \mathcal{U}=\frac{1}{2}\sum\limits_{\substack{s_{1}s_{2} \\ \alpha_{1}\alpha_{2} \\ \mathbf{T}_{1}\mathbf{T}_{2}}}\Phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})\mathsf{u}_{s_{1}}^{
 \alpha_{1}}(\mathbf{T}_{1})\mathsf{u}_{s_{2}}^{\alpha_{2}}(\mathbf{T}_{2}).
\end{equation}
The $\mathsf{u}_{s}^{\alpha}(\mathbf{T})$ atomic displacements are different from the $u_{s}^{\alpha}(\mathbf{T})$. $u_{s}^{\alpha}(\mathbf{T})$ measure the displacements from the minimum of the BOES $R_{s}^{0\alpha}(\mathbf{T})$
while $\mathsf{u}_{s}^{\alpha}(\mathbf{T})$ measure the displacements from trial equilibrium positions $\mathcal{R}_{s}^{\alpha}(\mathbf{T})$. We will name these trial equilibrium positions centroids. The same applies to 
$\Phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})$, which are trial 2BFC and not the harmonic ones $\phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})$. The advantage of choosing a 
trial potential which is harmonic is that $\rho_{\mathcal{H}}$ and $F_{\mathcal{H}}$ have closed analytical forms. 
\begin{multline}
 \label{gaussian_sscha}
 \rho_{\mathcal{H}}(\mathbf{R})=\langle\mathbf{R}|\rho_{\mathcal{H}}|\mathbf{R}\rangle=\\=A_{\mathcal{H}}exp\left(-\sum\limits_{\substack{s_{1}s_{2} \\ \alpha_{1}\alpha_{2} \\ \mathbf{T}_{1}\mathbf{T}_{2} \\ \mu}}\frac{\sqrt{
	 m_{s_{1}}m_{s_{2}}}}{2a_{\mu\mathcal{H}}^{2}}\epsilon_{\mu\mathcal{H}}^{s_{1}\alpha_{1}}(\mathbf{T}_{1})\epsilon_{\mu\mathcal{H}}^{s_{2}\alpha_{2}}(\mathbf{T}_{2})u_{s_{1}}^{\alpha_{1}}[\mathbf{T}_{1}](\mathbf{
 R})u_{s_{2}}^{\alpha_{2}}[\mathbf{T}_{2}](\mathbf{R})\right),
\end{multline}
\begin{equation}
	F_{\mathcal{H}}=\sum_{\mu}\left[\frac{\Omega^{(S)}_{\mu}}{2}+Tln\left(1-e^{-\beta\Omega^{(S)}_{\mu}}\right)\right],
\end{equation}
where $A_{\mathcal{H}}$ is a normalization constant and $a_{\mu\mathcal{H}}=\sqrt{coth(\beta\Omega^{(S)}_{\mu}/2)/(2\Omega^{(S)}_{\mu})}$ is called the normal length. $\rho_{\mathcal{H}}(\mathbf{R})$ 
is the probability to find the system described by $\mathcal{H}$ in the general ionic configuration $\mathbf{R}$. In normal coordinates space, $\rho_{\mathcal{H}}(\mathbf{R})$, is a product of Gaussians and the normal length 
is their standard deviation, which is given by the $\Omega_{\mu}^{(S)}$ frequencies. These Gaussians are centered in the centroid positions. $\Omega^{(S)}_{\mu}$ and $\epsilon_{s\mu\mathcal{H}}^{\alpha}$ are the frequencies and polarization vectors that diagonalize the SSCHA dynamical matrix $D_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}(S)}(\mathbf{T}_{1},\mathbf{T}_{2})=\Phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})/(\sqrt{m_{s_{1}}m_{s_{2}}})$. \\

The only parameters that contains the trial harmonic potential are $\mathcal{R}_{s}^{\alpha}(\mathbf{T})$ and $\Phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})$ with respect to 
which $\mathcal{F}_{H}[\mathcal{H}]$ needs to be minimized. For the minimization we can apply a conjugate gradient (CG) algorithm and at the end of the minimization, which is done in a subspace that 
preserves the crystal symmetries, we will get the $\boldsymbol{\mathcal{R}}$ positions or centroids and $\Phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})$ 2BFC that minimize 
the free energy including anharmonic effects. \\
%The centroid positions that minimize the SSCHA free energy are the centers of the SSCHA Gaussian wave functions and the trial 2BFC that minimize the SSCHA free 
%energy provide the width of these Gaussians. \\

For the CG minimization we need the expressions of the function and its derivatives with respect to $\boldsymbol{\mathcal{R}}$ and $\Phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})$
\begin{equation}
 \label{minim1}
 \mathcal{F}_{H}[\mathcal{H}]=F_{\mathcal{H}}+\int{d\mathbf{R}[U(\mathbf{R})-\mathcal{U}(\mathbf{R})]\rho_{\mathcal{H}}(\mathbf{R})},
\end{equation}
\begin{equation}
 \label{minim2}
 \boldsymbol{\nabla}_{\boldsymbol{\mathcal{R}}}\mathcal{F}_{H}[\mathcal{H}]=-\int{d\mathbf{R}[\mathbf{f}(\mathbf{R})-\mathbf{f}_{\mathcal{H}}(\mathbf{R})]\rho_{\mathcal{H}}(\mathbf{R})},
\end{equation}
\begin{multline}
 \label{minim3}
 \boldsymbol{\nabla}_{\Phi}\mathcal{F}_{H}[\mathcal{H}]=-\sum\limits_{\substack{s_{1}s_{2} \\ \alpha_{1}\alpha_{2} \\ \mathbf{T}_{1}\mathbf{T}_{2} \\ \mu}}\sqrt{\frac{m_{s_{1}}}{m_{s_{
	 2}}}}(\epsilon_{s_{1}\mu\mathcal{H}}^{\alpha_{1}}(\mathbf{T}_{1})\boldsymbol{\nabla}_{\Phi}lna_{\mu\mathcal{H}}+\boldsymbol{\nabla}_{\Phi}\epsilon_{s_{1}\mu\mathcal{H}}^{\alpha_{1}}(\mathbf{T}_{1}))
	\epsilon_{s_{2}\mu\mathcal{H}}^{\alpha_{2}}(\mathbf{T}_{2}) \\ \times\int{d\mathbf{R}[f_{s_{1}}^{\alpha_{1}}[\mathbf{T}_{1}](\mathbf{R})-f_{s_{1}\mathcal{H}}^{\alpha_{1}}[\mathbf{T}_{1}](\mathbf{
 R})](R_{s_{2}}^{\alpha_{2}}(\mathbf{T}_{2})-\mathcal{R}_{s_{2}}^{\alpha_{2}}(\mathbf{T}_{2}))\rho_{\mathcal{H}}(\mathbf{R})}.
\end{multline}
$\mathbf{f}(\mathbf{R})$ is the vector formed by all the atomic forces for the ionic configuration $\mathbf{R}$ and $\mathbf{f}_{\mathcal{H}}(\mathbf{R})$ are the forces defined by $\mathcal{H}$
\begin{equation}
	f_{s_{1}\mathcal{H}}^{\alpha_{1}}[\mathbf{T}_{1}](\mathbf{R})=-\sum_{s_{2}\alpha_{2}\mathbf{T}_{2}}\Phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{1},\mathbf{T}_{2})\mathsf{u}_{s_{2}}^{\alpha_{2}}[\mathbf{
 T}_{2}](\mathbf{R}).
\end{equation}
The only non-analytic terms in these equations are the integrals and the actual forces $\mathbf{f}(\mathbf{R})$. \\

A possible procedure for evaluating the integrals is to get higher order coefficients in the Taylor expansion, which is a difficult and time-consuming task. Within the SSCHA framework, these integrals are evaluated 
stochastically by using the relationship
\begin{equation}
 \label{stochastic}
\int{\mathbf{O}(\mathbf{R})\rho_{\mathcal{H}}(\mathbf{R})d\mathbf{R}}\simeq\frac{1}{N_{c}}\sum_{I=1}^{N_{c}}\mathbf{O}(\mathbf{R}_{I})\equiv\langle\mathbf{O}\rangle_{\rho_{\mathcal{H}}}.
\end{equation}
The set of $\mathbf{R}_{I}$ ionic configurations is created according to the distribution $\rho_{\mathcal{H}}(\mathbf{R})$. $\mathbf{O}$ is any operator that only depends on the ionic configuration and $N_{c}$ is the number of 
configurations we have created. The equality in Eq. \ref{stochastic} holds when $N_{c}\rightarrow\infty$. As we are dealing with a stochastic framework, the statistical error scales as $1/\sqrt{N_{c}}$. The advantage 
of using Eq. \ref{stochastic} is that the gradients in Eqs. \ref{minim2} and \ref{minim3} can be calculated by getting the forces acting on atoms in supercells in the configurations given by $\rho_{\mathcal{H}}$, which are easily 
extracted from electronic ground state calculations thanks to the Hellmann-Feynman 
theorem\cite{feynman1939forces}. \\

Once we calculate the gradient of the free energy, we can apply the CG method to minimize the free energy. The flowchart of the SSCHA method is the following. An initial guess $\mathcal{H}_{0}$ (in the first 
step $j=0$) is made for the trial Hamiltonian. This guess can be the harmonic Hamiltonian. However, it needs to be stable so we need to find another guess for materials with imaginary frequencies in the harmonic approximation. This 
trial Hamiltonian $\mathcal{H}_{0}$ is used to create $N_{c}$ ionic configurations according to $\rho_{\mathcal{H}_{0}}(\mathbf{R})$. We calculate the energies and atomic forces in each configuration and, finally, we are able to 
evaluate the integrals in Eq. \ref{minim1}, \ref{minim2}, and \ref{minim3}. This way we are able to perform a CG step and a new $\mathcal{H}_{j}$ is obtained. \\

At this point we would need to create new configurations by using the new $\rho_{\mathcal{H}_{j}}(\mathbf{R})$. However, this would be very inefficient as we would need to calculate energies and forces again. 
Instead, one can use a reweighting  importance sampling technique by changing Eq. \ref{stochastic} by
\begin{equation}
	\int{\mathbf{O}(\mathbf{R})\rho_{\mathcal{H}_{j}}(\mathbf{R})d\mathbf{R}}\simeq\frac{1}{N_{c}}\sum_{I=1}^{N_{c}}\mathbf{O}(\mathbf{R}_{I})\frac{\rho_{\mathcal{H}_{j}}}{\rho_{\mathcal{H}_{j_{0}}}},
\end{equation} 
where $j_{0}$ is the latest iteration at which configurations were created. As long as $\left\langle\frac{\rho_{\mathcal{H}_{j}}}{\rho_{\mathcal{H}_{j_{0}}}}\right\rangle_{\rho_{\mathcal{H}_{j_{0}}}}$ is not 
far from unity the configurations created with $\mathcal{H}_{j_{0}}$ can be reused. We can control this deviation from unity to get the statistical convergence or precision that we 
want. However, $\left\langle\frac{\rho_{\mathcal{H}_{j}}}{\rho_{\mathcal{H}_{j_{0}}}}\right\rangle_{\rho_{\mathcal{H}_{j_{0}}}}$ can get far from unity if all the weight constantly drifts from the uniform value, or it can remain 
close to unity if the configurations spread a lot. Thus, a more reliable statistical parameter to check is the Kong-Liu effective sample size\cite{monacelli2018pressure}
\begin{equation}
 N_{eff}=\frac{\left(\sum_{I}\rho_{\mathcal{H}_{j}}(\mathbf{R}_{I})\right)^{2}}{\sum_{I}\rho_{\mathcal{H}_{j}}^{2}}<N_{C}.
\end{equation}
A critical threshold can be defined as $\eta=\frac{N_{eff}}{N_{c}}$.
The effective sample size counts how many configurations are actually contributing to the Monte Carlo average, even if the $\rho_{\mathcal{H}_{j}}(\mathbf{R}_{I})$ are properly normalized. Finally, we will consider that the SSCHA 
minimization is converged when the gradient gets so small that the free energy change is less than a given threshold and the statistical criteria are fulfilled. 
In Fig. \ref{sscha-workflow}
\begin{figure}[h]
\begin{center}
\begin{tikzpicture}[node distance = 2cm, auto]
    % Place nodes
    \node [block] (init) {Initial trial Hamiltonian $\mathcal{H}_{0}$};
    \node [block, below of=init, node distance=3cm] (createconf) {Create ionic configurations $\{\mathbf{R}_{I}\}$with $\mathcal{H}_{j_{0}}$};
    \node [decision, below of=createconf] (calculate) {Calculate forces on supercells $\mathbf{f}(\mathbf{R}_{I})$};
    \node [block, below of=calculate, node distance=3cm] (calc-gradient) {Calculate the gradient of the free energy $\boldsymbol{\nabla}\mathcal{F}_{H}[\mathcal{H}_{j}]$};
    \node [block, right of=calc-gradient, node distance=6cm] (new-conf) {Create an extra set of configurations};
    \node [block, below of=calc-gradient] (gradient-step) {Conjugate gradient step $\mathcal{R}_{j+1}$, $\Phi(j+1)$, and $j=j+1$}; 
    \node [cloud, below of=gradient-step, node distance=2cm] (check-rho) {Statistics good?};
    \node [cloud, below of=check-rho, node distance=2cm] (precision) {Minimum found?};
    \node [block, left of=precision, node distance=6cm] (again) {Continue minimizing};
    \node [block, right of=check-rho, node distance=6cm] (update) {$j_{0}=j$};
	\node [block, below of=precision, node distance=3cm] (output) {Output quantities $\mathcal{H}=\mathcal{H}_{j}$, $\mathcal{F}_{H^{I}}[\mathcal{H}]$, $\boldsymbol{\mathcal{R}}_{\mathcal{H}}$, $\Omega^{(S)}_{\mu\mathcal{H}}$, and 
	$\boldsymbol{\epsilon}_{s\mu\mathcal{H}}$};
    % Draw edges
    \path [line] (init) -- node {$j=0$ and $j_{0}=0$}(createconf);
    \path [line] (createconf) -- (calculate);
    \path [line] (calculate) -- (calc-gradient);
    \path [line] (calc-gradient) -- (gradient-step);
    \path [line] (gradient-step) -- (check-rho);
    \path [line] (check-rho) -- node {no} (update);
    \path [line] (update) -- (new-conf);
    \path [line] (check-rho) -- node {yes} (precision);
    \path [line] (precision) -- node {no} (again);
    \path [line] (again) |- (calc-gradient);
    \path [line] (new-conf) |- (createconf);
    \path [line] (precision) -- node {yes}(output);
\end{tikzpicture}
\end{center}
\caption{Flowchart of the SSCHA minimization process.}
\label{sscha-workflow}
\end{figure}
we can see a scheme of the SSCHA minimization. \\

In Fig. \ref{1dimsscha} we show the application of the SSCHA in a one dimensional BOES at zero temperature.
\begin{figure}[h]
\begin{center}
\includegraphics[width=0.8\linewidth]{Figures/result.eps}
\caption[One dimensional example of the SSCHA]{One dimensional example of the SSCHA with atomic units for energy and displacement. The actual potential and the harmonic one are the black and red solid curves, respectively. The ground 
state SSCHA at zero temperature and exact wave functions are shown with dashed curves. Dotted lines show the energy of each ground state wave function.}
\label{1dimsscha}
\end{center}
\end{figure}
The potential we have chosen is $U(x)=-0.5x^{2}+0.5x^{4}$ and it is represented with a solid black line. The second derivative of this potential at the equilibrium position is negative, therefore, the harmonic approximation 
completely breaks down and perturbation theory cannot be applied in this case. We show the harmonic part of the potential with a solid red line. We have solved the problem exactly by solving the Schr\"odinger equation for 
a particle with unitary mass. We show the ground state wave function with a dashed black line and the ground state energy with a pointed black line. The SSCHA results at zero temperature are shown in blue. As we can 
see, the SSCHA is able to find a very good approximation for the ground state energy and wave functions even if perturbation theory cannot be applied in this case.  

\subsection{The stress tensor in the self-consistent harmonic approximation}
\label{scha-stress-section}

In Eq. \ref{bo-stress} we saw how to calculate the Born-Oppenheimer stress tensor which does not include any effect from the thermal and quantum fluctuations of the ions. In this section we will see how to calculate 
the SSCHA stress tensor $P_{\alpha\beta}^{SSCHA}$ which will include these effects at an anharmonic level. \\

In this section, the parameters of the trial Hamiltonian are $\boldsymbol{\mathcal{R}}$, $\Phi_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}}(\mathbf{T}_{2},\mathbf{T}_{2})$ and $\{\mathbf{a}_{i}\}$. We will assume 
that $\boldsymbol{\mathcal{R}}$ are the internal coordinates and $\{\mathbf{a}_{i}\}$ are the lattice vectors that define the unit cell. Within the SSCHA, the stress tensor is defined as the derivative of the free energy 
with respect to the strain tensor
\begin{equation}
\label{scha-stress}
 P_{\alpha\beta}^{SSCHA}(\boldsymbol{\mathcal{R}},\{\mathbf{a}_{i}\})=-\frac{1}{\Omega}\frac{\partial\mathcal{F}_{H}[\boldsymbol{\mathcal{R}},\{\mathbf{a}_{i}\}]}{\partial\epsilon_{\alpha\beta}}\vline_{_{_{_{_{_{_{_{
\boldsymbol{\epsilon}=0}}}}}}}}, 
\end{equation}  
where we assume that the trial 2BFC are the ones that minimize the trial free energy for the given centroids and 
lattice vectors. Strain affects lattice vectors and average central positions 
\begin{equation}
a_{i}^{'\alpha}=a_{i}^{\alpha}+\sum_{\beta=1}^{3}\epsilon_{\alpha\beta}a_{i}^{\beta},
\end{equation}
\begin{equation}
\mathcal{R}_{n}^{'\alpha}=\mathcal{R}_{n}^{\alpha}+\sum_{\beta=1}^{3}\epsilon_{\alpha\beta}\mathcal{R}_{n}^{\beta}.
\end{equation}
This is equivalent to performing a strain keeping fixed the internal crystal coordinates of the system. In order to compare the SSCHA stress tensor with the BO one, the SSCHA tensor can be divided into three 
parts\cite{monacelli2018pressure}:
\begin{equation}
 P_{\alpha\beta}^{SSCHA}(\boldsymbol{\mathcal{R}},\{\mathbf{a}_{i}\})=P_{\alpha\beta}^{BO}(\boldsymbol{\mathcal{R}},\{\mathbf{a}_{i}\})+P_{\alpha\beta}^{FLC}(\boldsymbol{\mathcal{R}},\{\mathbf{a}_{i}\})+
 P_{\alpha\beta}^{FRC}(\boldsymbol{\mathcal{R}},\{\mathbf{a}_{i}\}),
\end{equation}
where $P_{\alpha\beta}^{BO}$ is the static contribution from the BO stress in Eq. \ref{bo-stress}, $P_{\alpha\beta}^{FLC}$ is the contribution of the fluctuations to the stress, and $P_{\alpha\beta}^{FRC}$ is an extra 
term that takes into account the work necessary to move the centroids according to the applied strain. The expressions for these stress tensors are
\begin{multline}
 \label{stress-fluctuations}
 P_{\alpha\beta}^{FLC}(\boldsymbol{\mathcal{R}},\{\mathbf{a}_{i}\})=\langle P_{\alpha\beta}^{BO}(\boldsymbol{\mathcal{R}},\{\mathbf{a}_{i}\})\rangle_{\rho_{\mathcal{H}}}-
 P_{\alpha\beta}^{BO}(\boldsymbol{\mathcal{R}},\{\mathbf{a}_{i}\})- \\ -\frac{1}{2\Omega}\sum_{s\mathbf{T}}\langle(f_{s\mathcal{H}}^{\alpha}(\mathbf{T})\mathsf{u}_{s}^{\beta}(\mathbf{T})+
 f_{s\mathcal{H}}^{\beta}(\mathbf{T})\mathsf{u}_{s}^{\alpha}(\mathbf{T}))\rangle_{\rho_{\mathcal{H}}},
\end{multline}
\begin{equation}
 P_{\alpha\beta}^{FRC}(\boldsymbol{\mathcal{R}},\{\mathbf{a}_{i}\})=\frac{1}{2\Omega}\sum_{s\mathbf{T}}(\mathcal{R}_{s}^{\beta}(\mathbf{T})\langle f_{s}^{\alpha}(\mathbf{T})-f_{s\mathcal{H}}^{\alpha}(\mathbf{
 T})\rangle_{\rho_{\mathcal{H}}}+\mathcal{R}_{s}^{\alpha}(\mathbf{T})\langle f_{s}^{\beta}(\mathbf{T})-f_{s\mathcal{H}}^{\beta}(\mathbf{T})\rangle_{\rho_{\mathcal{H}}}).
\end{equation}
The last term in Eq. \ref{stress-fluctuations} makes fluctuations on pressure disappear in pure harmonic crystals\cite{monacelli2018pressure}, that is why we say that $P_{\alpha\beta}^{BO}$ does not include the effect
of fluctuations. \\

The SSCHA stress tensor can be calculated with the knowledge of the BOES, the atomic forces and the BO stress tensor. 
The stochastic framework in Eq. \ref{stochastic} is also valid for the stress calculation. 

\subsection{The free energy Hessian and second-order phase transitions within the SSCHA}
\label{free-energy-section}

In section \ref{sscha-basics} we have seen how to get an approximation for the vibrational free energy. For that purpose, the SSCHA uses trial centroids and 2BFC and will provide us with the $\boldsymbol{\mathcal{R}}$ 
and $\boldsymbol{\Phi}$ that minimize the free energy of the system. In this section we will see 
how to calculate the free energy Hessian within the SSCHA and use it to predict second-order phase transitions where the order parameters are the centroids $\boldsymbol{\mathcal{R}}$. \\

Displacive transitions occur, for instance, in materials with ferroelectric or charge density wave transitions. In this kind of phase transitions, according to Landau's theory of second-order phase 
transitions\cite{lifshitz1980landau}, at high temperature the free energy has a minimum in a high symmetry configuration $\boldsymbol{\mathcal{R}}_{hs}$, but, on lowering the temperature, $\boldsymbol{\mathcal{R}}_{hs}$ 
becomes a saddle point at the transition temperature $T_{c}$. Therefore, the free energy Hessian evaluated at $\boldsymbol{\mathcal{R}}_{hs}$, $\partial^{2}F/\partial\boldsymbol{\mathcal{R\partial\boldsymbol{\mathcal{
R}}}}|_{\boldsymbol{\mathcal{R}}_{hs}}$, at high temperature is positive definite but it develops one or multiple negative eigendirections at $T_{c}$. \\

In Fig. \ref{transition} we can see a schematic representation of the free energy $\mathcal{F}$ with respect to the 
order parameter $Q$ (a particular position of the centroids in this case) for different temperatures for a system 
with a second-order phase transition.
\begin{figure}[h]
\begin{center}
\includegraphics[width=0.8\linewidth]{Figures/data.eps}
\caption[Free energy as a function of temperature in a second-order phase transition]{Free energy as a function of the order parameter for three different temperatures in a system with a second-order phase transition. The 
blue line corresponds to a temperature below the critical temperature, the red line to the critical temperature and the black line to a temperature above the critical temperature.}
\label{transition}
\end{center}
\end{figure}
As we can see, at $T>T_{c}$, the second derivative of the free energy with respect to $Q$ is positive, and the system stays in the high symmetry phase. As temperature decreases, at $T=T_{c}$, $\partial^{2}F/\partial Q^{2}$ equals 
$0$, and once the temperature gets below the transition temperature the free energy develops some minima and the system goes to the low symmetry phase. In second-order phase transitions the process is reversible and the critical 
temperature does not change by approaching $T_{c}$ from below or above. \\

The SSCHA free energy Hessian can be computed by using the analytic formula\cite{bianco2017second}
\begin{equation}
 \label{free-energy-hessian}
 \frac{\partial^{2}\mathcal{F}}{\partial\boldsymbol{\mathcal{R}}\partial\boldsymbol{\mathcal{R}}}=\boldsymbol{\Phi}+\overset{(3)}{\boldsymbol{\Phi}}\boldsymbol{\Lambda}(0)[\mathbf{1}-\overset{(4)}{\boldsymbol{
\Phi}}\boldsymbol{\Lambda}(0)]^{-1}\overset{(3)}{\boldsymbol{\Phi}},
\end{equation}
where 
\begin{equation}
 \overset{(n)}{\boldsymbol{\Phi}}=\left\langle\frac{\partial^{n}U}{\partial\mathbf{R}^{n}}\right\rangle_{\rho_{\mathcal{H}}}, \hspace{0.2cm} n>2,
\end{equation}
are the non-perturbative nBFC which should not be confused with the perturbative nBFC in Eq. \ref{perturbative-nbfc} that are calculated as $n^{th}$ derivatives of the BOES at the atomic positions defined as the minimum of 
the BOES. In Eq. \ref{free-energy-hessian} the value $z=0$ of the fourth-order tensor $\boldsymbol{\Lambda}(z)$ is used. For a generic complex number $z$ $\boldsymbol{\Lambda}(z)$ is defined as
\begin{multline}
\Lambda_{s_{1}s_{2}s_{3}s_{4}}^{\alpha_{1}\alpha_{2}\alpha_{3}\alpha_{4}}(\mathbf{T}_{1},\mathbf{T}_{2},\mathbf{T}_{3},\mathbf{T}_{4};z)=-\frac{1}{2}\sum_{\mu\nu}\tilde{F}(z,\Omega^{(S)}_{\mu},\Omega^{(S)}_{\nu})\sqrt{\frac{
	1}{2m_{s_{1}}\Omega^{(S)}_{\mu}}}\epsilon_{s_{1}\mu\mathcal{H}}^{\alpha_{1}}(\mathbf{T}_{1})\times\\\times\sqrt{\frac{1}{2m_{s_{2}}\Omega^{(S)}_{\nu}}}\epsilon_{s_{2}\nu\mathcal{H}}^{\alpha_{2}}(\mathbf{T}_{2})\sqrt{\frac{1}{2m_{
		s_{3}}\Omega^{(S)}_{\mu}}}\epsilon_{s_{3}\mu\mathcal{H}}^{\alpha_{3}}(\mathbf{T}_{3})\sqrt{\frac{1}{2m_{s_{4}}\Omega^{(S)}_{\nu}}}\epsilon_{s_{4}\nu\mathcal{H}}^{\alpha_{4}}(\mathbf{T}_{4}),
\end{multline}
where $\tilde{F}$ is defined as 
\begin{multline}
\label{raffaello-function}
 \tilde{F}(\omega,\omega_{1},\omega_{2})=\left[\frac{2(\omega_{1}+\omega_{2})[1+n_{B}(\omega_{1})+n_{B}(\omega_{2})]}{(\omega_{1}+\omega_{2})^{2}-(\omega+i\delta)^{2}}\right]+\\+\left[\frac{2(\omega_{1}-\omega_{2})[
 n_{B}(\omega_{2})-n_{B}(\omega_{1})]}{(\omega_{2}-\omega_{1})^{2}-(\omega+i\delta)^{2}}\right].
\end{multline}
\\

In all the systems considered in this thesis, $\overset{(4)}{\boldsymbol{\Phi}}\boldsymbol{\Lambda}(0)$ is negligible compared to the unity, therefore, we can rewrite Eq. \ref{free-energy-hessian} as
\begin{equation}
 \frac{\partial^{2}\mathcal{F}}{\partial\boldsymbol{\mathcal{R}}\partial\boldsymbol{\mathcal{R}}}=\boldsymbol{\Phi}+\overset{(3)}{\boldsymbol{\Phi}}\boldsymbol{\Lambda}(0)\overset{(3)}{\boldsymbol{\Phi}}.
\end{equation}
We will define the phonons defined from the free energy as the eigenvalues ($\Omega^{(F)}_{\mu}(\boldsymbol{q})$) of
the Fourier transform of
\begin{equation}
 \label{free-energy-dynamical-matrix}
 D_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}(F)}(\mathbf{T}_{1},\mathbf{T}_{2})=\frac{1}{\sqrt{m_{s_{1}}m_{s_{2}}}}\frac{\partial^{2}\mathcal{F}}{\partial\mathcal{R}_{s_{1}}^{\alpha_{1}}(\mathbf{T}_{1})\partial\mathcal{R}_{s_{2}}^{\alpha_{
 2}}(\mathbf{T}_{2})}.
\end{equation} 
Evaluating through Eq. \ref{free-energy-hessian} the free energy Hessian at $\boldsymbol{\mathcal{R}}_{hs}$ and studying its spectrum as a function of temperature, we can predict the occurrence of a displacive phase transition 
and estimate $T_{c}$. 

\subsection{Perturbative limit of the SSCHA}
\label{pertubative-limit-sscha}

In this part we will analyze the perturbative limit of the SSCHA in order to make an analogy with perturbation theory and understand better the anharmonic phonons within the SSCHA. \\

From the SSCHA equations, retaining only the lowest-order correction to the harmonic values $\mathcal{R}_{s(0)}^{\alpha}(\mathbf{T})$ (with the subindex $(0)$ we mark that these centroid positions are the minimum of the BOES) and 
$\boldsymbol{\phi}$, the following can be obtained\cite{bianco2017second}
\begin{equation}
 \mathbf{D}^{(S)}\simeq\mathbf{D}+\overset{(T)}{\boldsymbol{\Pi}}{}^{(0)}+\overset{(L)}{\boldsymbol{\Pi}}{}^{(0)},
\end{equation}
where $\overset{(T)}{\boldsymbol{\Pi}}{}^{(0)}$ and $\overset{(L)}{\boldsymbol{\Pi}}{}^{(0)}$ are the tadpole and loop contributions to the harmonic self-energy and $\mathbf{D}$ is the harmonic dynamical matrix. From 
this equation it is clear that, in the perturbative limit, the anharmonic line shift of the auxiliary $\mathbf{D}^{(S)}$ dynamical matrix with respect to the harmonic one is given by the tadpole and loop 
contributions to the self-energy. It is extremely interesting to note that the SSCHA could be used to include the loop and tadpole diagrams to the self-energy in materials where the perturbation theory works but 
the calculation of the 4BFC is too cumbersome. Then, the remaining bubble self-energy could be added on top of the SSCHA by using perturbation theory\cite{paulatto2015first}. \\

In order to obtain the dynamical matrix that comes from the free energy defined in Eq. \ref{free-energy-dynamical-matrix} and be able to predict second-order phase transitions, we need also the harmonic static bubble
\begin{equation}
 \label{lowest-perturbative-order}
 \mathbf{D}^{(F)}\simeq\mathbf{D}+\overset{(T)}{\boldsymbol{\Pi}}{}^{(0)}+\overset{(L)}{\boldsymbol{\Pi}}{}^{(0)}+\overset{(B)}{\boldsymbol{\Pi}}{}^{(0)}(0)\simeq\mathbf{D}^{(S)}+\overset{(B)}{\boldsymbol{\Pi}}{}^{(0)}(0).
\end{equation}  
It is interesting to observe that, at the lowest perturbative order, the free energy curvature takes into account only the static harmonic bubble, whereas within perturbation theory (see Eq. \ref{self-energy} 
in section \ref{perturbation-theory-third}) the self-energy depends on the frequency. This is consistent with the fact that the SSCHA is a static theory. It is also interesting to note 
that Eq. \ref{lowest-perturbative-order} shows that $\overset{(4)}{\boldsymbol{\Phi}}\boldsymbol{\Lambda}(0)$ is neglected in the curvature formula, which means that it is discarded at lowest perturbative order. 
In the next section we describe a possible dynamic extension for the SSCHA studied in Ref. \cite{bianco2017second} that can potentially calculate the lifetime of phonons in the nonperturbative regime.
 
\subsection{Dynamical properties of solids and phonon frequencies within the SSCHA}
\label{dynamical-sscha}

So far we have seen that the SSCHA is a static theory, which means that we cannot access dynamical properties, such as, the line width of a phonon which makes impossible the calculation of spectral functions or 
the thermal conductivity of a solid. \\

Within the SSCHA it is possible to formulate a valid ansatz in order to calculate dynamical properties of crystals. The main idea behind this ansatz is to take the nonperturbative 
version of Eq. \ref{lowest-perturbative-order} and assume the frequency dependence of the bubble self-energy. We show the diagrammatic representation of this ansatz in Fig. \ref{green-ansatz}. 
\begin{figure}[h]
\begin{center}
\includegraphics[width=0.95\linewidth]{Figures/dyson-ansatz.pdf}
\caption[Diagramatic representation of SSCHA Dyson equation]{Diagrammatic representation of the Dyson equation got with a dynamical ansatz within the SSCHA. The dashed line corresponds to the 
SSCHA propagator. The double solid line corresponds to the full propagator.}
\label{green-ansatz}
\end{center}
\end{figure}
In Fig. \ref{green-ansatz} the SSCHA Green's function is defined as
\begin{equation}
 \overset{-1}{G}{}_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}(S)}(\mathbf{T}_{1},\mathbf{T}_{2};z)=z^{2}\delta_{s_{1}s_{2}}\delta_{\alpha_{1}\alpha_{2}}\delta_{\mathbf{T}_{1}\mathbf{T}_{2}}-D_{s_{1}s_{2}}^{\alpha_{1}\alpha_{2}(S)}(\mathbf{
 T}_{1},\mathbf{T}_{2}).
\end{equation}
The diagrammatic representation in Fig. \ref{green-ansatz} is translated into the following Dyson equation
\begin{equation}
 \mathbf{G}(z)=\mathbf{G}^{(S)}(z)+\mathbf{G}^{(S)}(z)\boldsymbol{\Pi}^{(S)}(z)\mathbf{G}(z).
\end{equation}
\\

This ansatz is justified by the fact that in the lowest-order perturbative limit it gives the same result 
as the perturbation theory in section \ref{perturbation-theory-third}. Within this assumptions, the SSCHA self-energy can be written as\cite{bianco2017second}
\begin{equation}
	\label{full-sscha-se}
	\boldsymbol{\Pi}^{(S)}(z)=\boldsymbol{M}^{-\frac{1}{2}}\overset{(3)}{\boldsymbol{\Phi}}\boldsymbol{\Lambda}(z)[\boldsymbol{1}-\overset{(4)}{\boldsymbol{\Phi}}\boldsymbol{\Lambda}(z)]^{-1}\overset{(3)}{\boldsymbol{\Phi}}\boldsymbol{M}^{-\frac{1}{2}},
\end{equation} 
where $M_{ab}=\delta_{ab}m_{a}$ is the mass matrix. As in the static case, we can neglect the fourth-order term and 
rewrite the remaining self-energy, which is the bubble self-energy
\begin{equation}
 \boldsymbol{\Pi}^{(S)}(z)\simeq\overset{(B)}{\boldsymbol{\Pi}}{}^{(S)}(z)=\boldsymbol{M}^{-\frac{1}{2}}\overset{(3)}{\boldsymbol{\Phi}}\boldsymbol{\Lambda}(z)\overset{(3)}{\boldsymbol{\Phi}}\boldsymbol{M}^{-\frac{1}{2}},
\end{equation}
With this self-energy, basically, we get an analogous theory of the perturbation theory, but instead of having harmonic frequencies $\omega_{\mu}(\mathbf{q})$ we 
have the auxiliary phonon frequencies $\Omega^{(S)}_{\mu}(\mathbf{q})$ and instead of having the perturbative 3BFC $\overset{(3)}{\phi}{}_{s_{1}s_{2}s_{2}}^{\alpha_{1}\alpha_{2}\alpha_{3}}(\mathbf{T}_{1},\mathbf{
 T}_{2},\mathbf{T}_{3})$ we have the nonperturbative ones $\overset{(3)}{\Phi}{}_{s_{1}s_{2}s_{2}}^{\alpha_{1}\alpha_{2}\alpha_{3}}(\mathbf{T}_{1},\mathbf{T}_{2},\mathbf{T}_{3})$. By setting $z=0$ we recover the static limit and these 
 phonons are equivalent to the ones defined from the free energy Hessian ($\boldsymbol{D}^{(F)}$) in 
 section \ref{free-energy-section}. \\

At this points we can recalculate the spectral function by using the 3BFC given by the SSCHA. In this case, as we are working with a non-perturbative theory, the Lorentzian approximation is not justified and its validity must be checked in each system. In Fig. \ref{instoy2} we show a cartoon situation where the Lorentzian approximation does not hold.
\begin{figure}[h]
\begin{center}
\includegraphics[width=0.9\linewidth]{Figures/ins-toy2.eps}
\caption[SSCHA and harmonic spectral functions]{SSCHA and harmonic spectral functions where the Lorentzian approximation does not hold.}
\label{instoy2}
\end{center}
\end{figure}
In this case the spectral functions are not Lorentzians and they can show strongly anharmonic features such as: shoulders, satellite peaks$\dots$ As the Lorentzian picture is lost, $\Gamma_{\mu}(\mathbf{q})$ and $\Omega_{\mu}(\mathbf{q})$ are not good representatives of that phonon. The spectral function of these kind of materials can be very difficult to study from an experimental point of view, since more peaks than modes can appear or two modes can appear as only one. It is important to remark that even in nonperturbative anharmonicity is important in a system the Lorentzian approximation may hold. \\

The SSCHA has proven to be an extremely powerful method for including anharmonic effects at a nonperturbative level. It has been successfully applied in bulk and monolayer materials including 
superconductors\cite{errea2013first,errea2016quantum}, materials undergoing charge density wave 
transitions\cite{leroux2015strong,bianco2019quantum} and ferroelectric transitions\cite{ribeiro2018strong}, 
thermoelectric materials\cite{aseginolaza2019phonon}\dots
